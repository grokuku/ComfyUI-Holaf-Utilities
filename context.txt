--- START OF FILE context.txt ---

R√àGLES OP√âRATIONNELLES :

1.  **Gestion des fichiers manquants :** Si un fichier mentionn√© est n√©cessaire √† ma compr√©hension ou √† l'ex√©cution d'une t√¢che mais n'a pas √©t√© fourni pr√©c√©demment, ne l'invente jamais. Signale-moi qu'il est manquant et que tu as besoin que je te fournisse son contenu.

2.  **Format des modifications de fichiers :**
    *   Lorsqu'une modification est apport√©e √† un fichier, fournis une commande `sed` pour Git Bash, **en une seule ligne**, permettant d'appliquer ce patch. (encapsuler l'argument de la commande sed dans des guillemets simples (') au lieu de guillemets doubles)
    *   **Condition :** Ne fournis cette commande `sed` que si elle est basique et ne risque pas de generer une erreur.
    *   Dans ce cas (commande `sed` sans risque), ne montre pas les blocs de code modifi√©s, donne uniquement la commande `sed`.
    *   **Restriction d'outil :** N'utilise que `sed` pour ces commandes de patch. N'utilise jamais d'autres outils (comme `patch`, `awk`, `tee`, etc.) pour g√©n√©rer la commande de modification.
    *   **Alternative :** Si la commande `sed` requise (en respectant la contrainte d'une seule ligne) risquerait de ne pas fonctionner correctement, ou si une commande `sed` en une seule ligne n'est pas r√©alisable pour la modification demand√©e, ne fournis pas de commande. √Ä la place, donne-moi le contenu int√©gral du fichier modifi√©.

3.  **Flux de travail s√©quentiel :** Apr√®s avoir propos√© une modification (commande `sed` ou fichier complet) pour un fichier, attends explicitement l'accord de l'utilisateur (et non du LLM) avant de proposer des modifications pour un fichier suivant ou de continuer sur une autre t√¢che.

4.  **Principe de moindre intervention :** Ne fais jamais de z√®le. Ne modifie pas des sections de code qui fonctionnent correctement si cela n'est pas explicitement demand√© ou absolument n√©cessaire pour la t√¢che en cours.

5.  **Anticipation des erreurs et suggestion de v√©rification :** N'assume pas que les modifications propos√©es fonctionneront parfaitement du premier coup. Apr√®s avoir propos√© une modification, sugg√®re bri√®vement les points cl√©s que je devrais v√©rifier ou les tests simples que je pourrais effectuer pour m'assurer du bon fonctionnement.


INSTRUCTION INITIALE :
Voici un projet (les fichiers et l'arborescence te seront fournis). Analyse-le attentivement. Une fois ton analyse termin√©e, signale-moi que tu es pr√™t √† commencer √† travailler sur les modifications en respectant les r√®gles ci-dessus.

Ne fait aucune optimisation de code si ca n'est pas explicitement demand√©.
Ne fait aucune modification sur des parties de codes qui n'on pas la necessit√© d'etre modifi√© pour la tache en cours.




FILE_TREE_ANALYSIS:
# --- Root Directory ---
üìÅ holaf_image_viewer_backend/
  > Backend logic for the Image Viewer.
  üìÅ routes/
    > Modular API route handlers for the Image Viewer.
    üìÑ __init__.py
      > Empty. Placeholder.
    üìÑ edit_routes.py
      > Handles image editing operations (non-destructive).
    üìÑ export_routes.py
      > Prepares and serves image export packages.
    üìÑ file_ops_routes.py
      > Handles file system operations (delete, restore).
      > [**NEEDS REVIEW**] La logique de suppression doit √™tre v√©rifi√©e pour s'assurer qu'elle d√©place/supprime √©galement tous les fichiers sidecar (.json, .txt, .edt, .xmp) associ√©s √† une image.
    üìÑ image_routes.py
      > [**REFACTORED & CRITICAL**] Core image listing and filtering. La route `/list` a √©t√© refactoris√©e pour accepter un objet JSON de filtres structur√©. La route `/filter-options` retourne maintenant aussi la liste compl√®te des tags.
      @ GET /holaf/images/filter-options
      @ POST /holaf/images/list
    üìÑ metadata_routes.py
      > Handles metadata fetching, extraction, and injection.
      > [**NEEDS UPDATE**] √Ä √©tendre pour g√©rer l'injection/extraction des tags via les m√©tadonn√©es XMP.
    üìÑ thumbnail_routes.py
      > Manages thumbnail lifecycle.
    üìÑ utility_routes.py
      > Misc utility routes for the viewer.
  üìÑ __init__.py
    > Exposes BE functions and routes to the main `__init__.py`.
  üìÑ logic.py
    > [**UPDATED & CRITICAL**] Core image viewer logic. La logique de scan/synchronisation a √©t√© √©tendue pour d√©tecter les fichiers sidecar (.txt, .json, .edt, .xmp), lire les tags depuis les fichiers XMP, et mettre √† jour les nouveaux drapeaux bool√©ens et les tables de tags dans la DB. **D√©pend de `python-xmp-toolkit`**.
  üìÑ routes.py
    > [DEPRECATED]
  üìÑ worker.py
    > Background threads for all Image Viewer tasks.
    > [**NEEDS UPDATE**] Le `run_filesystem_monitor` doit d√©clencher la nouvelle logique de scan enrichie (d√©tection sidecar, lecture des tags, mise √† jour des drapeaux) lorsqu'un fichier est ajout√© ou modifi√©.
üìÅ js/
  > Frontend assets.
  (le reste de l'arborescence est inchang√©)
...
üìÑ holaf_database.py
  > [**UPDATED & CRITICAL**] Manages the SQLite database. Le sch√©ma a √©t√© migr√© jusqu'√† la version 12 pour supporter le nouveau syst√®me de filtrage et de tags.
üìÑ requirements.txt
  > Python package dependencies. [**NEEDS UPDATE**] Doit √™tre mis √† jour pour inclure `python-xmp-toolkit`.

PROJECT_STATE:
  CURRENT_INVESTIGATION: {
    "bug": "[bugfix, regression, editor_unsaved_warning]",
    "description": "L'√©diteur ne pr√©vient plus l'utilisateur s'il quitte avec des modifications non sauvegard√©es. Il s'agit d'une r√©gression d'une fonctionnalit√© existante."
  }
  ACTIVE_BUGS: {
    "[bugfix, regression, editor_unsaved_warning]": "Le dialogue de confirmation pour les modifications non sauvegard√©es dans l'√©diteur ne s'affiche plus."
  }
  IN_PROGRESS:
    - **T√¢che :** `[project, architecture, tagging_and_performance_rework]`
    - **Statut :** **Phases Backend et Frontend TERMIN√âES.**
    - **R√©sum√© des modifications :** L'architecture de la base de donn√©es, la logique de scan, l'API de filtrage et l'interface utilisateur du frontend ont √©t√© enti√®rement remani√©es pour prendre en charge un syst√®me de filtrage avanc√© bas√© sur les tags et les m√©tadonn√©es.
    - **PROCHAINE √âTAPE :**
      - **Phase :** Correction de R√©gression Critique.
      - **Objectif :** R√©tablir le dialogue d'avertissement pour les modifications non sauvegard√©es dans l'√©diteur.
      - **Fichiers probables :** `js/image_viewer/image_viewer_editor.js`, `js/holaf_image_viewer.js`.

  ROADMAP:
    Global:
      - [new_tool, session_log_tool]
      - [backend, periodic_maintenance_worker]
    ImageViewer:
      - [**URGENT_FIX**, bugfix, regression, editor_unsaved_warning] # L'avertissement de modifications non sauvegard√©es ne fonctionne plus.
      - [**project, architecture, tagging_and_performance_rework**]
        - **Plan d'action d√©taill√©:**
          - **1. Optimisation de la Base de Donn√©es (Index manquants):** `[COMPLETED]`
          - **2. Architecture du Syst√®me de Tags (Backend):** `[COMPLETED]`
          - **3. Centralisation des M√©tadonn√©es Sidecar (Performance):** `[COMPLETED]`
          - **4. Refonte de l'Interface de Filtrage (Frontend):** `[COMPLETED]`
          - **4.1. Am√©lioration UX/UI du filtre "Metadata & Sidecars":** `[TODO]` # Revoir la pr√©sentation des boutons.
          - **5. Fiabilisation des Op√©rations sur Fichiers:** `[TODO]`
      (Le reste de la roadmap est inchang√©)
  COMPLETED_FEATURES:
    - [bugfix, regression, terminal_functionality]
    - [bugfix, state, folder_filter_reset_on_reopen]
    - [bugfix, ui, delete_button_unresponsive]
    - [bugfix, logic, additive_workflow_filter]
    - [feature, ui, workflow_filter_none_option]
    - [bugfix, realtime, data_integrity]
    - [major_refactor, backend, realtime_file_monitoring]
    - [fix, performance, backend_filter_optimization]
    - [fix, ui, gallery_empty_state_rendering]
    - [fix, ui, thumbnail_slider_realtime_update_fix]
    - [fix, navigation, zoom_exit_scroll_alignment]
    - [fix, navigation, gallery_keyboard_navigation_highlight]
    - [fix, ui, gallery_fullscreen_icon_click]
    - [fix, navigation, enter_key_opens_edit_view]
    - [fix, navigation, zoom_return_scroll_jump]
    - [fix, performance, gallery_scroll_optimization]
    - [fix, ui, gallery_autofill_layout]
    - [fix, performance, initial_load_speed]
    - [feature, ui, dual_scroll_loading_strategy]
    - [major_refactor, performance, gallery_virtualization]
    - [feature, backend, db_versioning_and_migration]
    - [fix, performance, gallery_scalability]
    - [feature, ui, export_dialog_advanced_nav]
    - [feature, ui, dialog_keyboard_navigation]
    - [fix, ui, focus_steal_on_controls]
    - [fix, ui, dialog_z_index_fullscreen]
    - [feature, ui, export_unsaved_changes_dialog]
    - [fix, ui, search_scope_buttons_unresponsive]
    - [fix, ui, editor_visibility_on_click]
    - [fix, ui, filter_label_cleanup]
    - [fix, ui, scope_buttons_responsive]
    - [fix, state, folder_lock_persistence]
    - [fix, ui, editor_previews_on_fullscreen_stale]
    - [feature, ui, folder_filter_enhancements]
    - [fix, ui, gallery_last_row_justification]
    - [fix, ui, thumbnail_fit_toggle_immediate_update]
    - [feature, ui, spacebar_to_toggle_selection_in_gallery]
    - [fix, ui, actions_target_active_image_in_zoom_view]
    - [fix, ui, editor_previews_in_fullscreen]
    - [fix, ui, thumbnail_refresh_on_edit_save]
    - [refactor, ui, gallery_differential_rendering]
    - [fix, ui, filter_race_condition]
    - [fix, ui, gallery_selection_bug]
    - [fix, ui, filter_persistence_partial]
    - [feature, ui, gallery_empty_on_no_folder_selection]
    - [feature, ui, editor_save_cancel_and_unsaved_warning] # THIS IS THE REGRESSION
    - [feature, backend, thumbnail_regeneration_with_edits]
    - [feature, state_driven_architecture]
    - [refactor, fix, image_viewer_editor_and_navigation_state]
    - [refactor, image_viewer_infopane_state_driven]
    - [fix, image_viewer_selection_and_state_bug]
    - [fix, image_viewer_filter_persistence_full]
    - [fix, toast_theming_and_readability]
    - [feature, ui, toasts_notification_system_base]
    - [major_refactor_backend_frontend]
    - [image_editor_base_architecture]
    - [image_viewer_trashcan]
    - [image_viewer_metadata_tools]
    - [image_editor_initial_bugfixes]
    - [thumbnail_cache_system]
    - [fix, export_workflow_save_fails]
    - [feature, ui, image_viewer_reset_filters_button]
    - [fix, ui, thumbnail_size_realtime_update]
    - [fix, state, folder_filter_visual_restore_on_startup]
--- END OF FILE context.txt ---