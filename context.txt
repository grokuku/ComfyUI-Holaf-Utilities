--- START OF FILE context.txt ---

### Purpose
This file serves as the **primary source of truth** and **cognitive map** for the Large Language Model (LLM) working on AiKore. Its goal is to provide a complete architectural understanding without requiring the LLM to read the source code of every file in every session. It bridges the gap between the raw file tree and the high-level business logic.

### Protocol for Updates
When the user requests a "context update" or when a major feature is implemented, the following information MUST be integrated/updated in this file:
1.  **Structural Changes**: If files are created, renamed, moved, or deleted, update **Section 2 (File Structure)** to reflect the new tree and the responsibility of the new files.
2.  **Schema Evolutions**: If `models.py` or `migration.py` changes, update **Section 4 (Database Schema)** to reflect the current V-version and columns.
3.  **Logic Shifts**: If the core way the backend handles processes, ports, saving, or networking changes, update **Section 3 (Key Concepts)**.
4.  **New Dependencies**: If `Dockerfile` or `requirements.txt` changes significantly (new tools like KasmVNC, new libs), update **Section 1 (Stack)**.

**Golden Rule**: Never paste raw code blocks in this file. Use concise, high-level functional descriptions to minimize token usage while maximizing understanding.

---

RÃˆGLES OPÃ‰RATIONNELLES (LLM INSTRUCTIONS) :

1.  **Gestion des fichiers manquants :** Ne jamais inventer de code. Demander explicitement les fichiers manquants.
2.  **Format des modifications :**
    *   Utiliser `sed` (une ligne, guillemets simples) pour les petits patchs sans risque.
    *   Fournir le **fichier complet** pour toute modification complexe ou risquÃ©e (DÃ©faut).
3.  **Flux sÃ©quentiel :** Attendre validation utilisateur aprÃ¨s chaque fichier modifiÃ©.
4.  **Moindre intervention :** Ne modifier que le strict nÃ©cessaire.
5.  **Bilinguisme :** Interactions en FranÃ§ais, Code/Commentaires en Anglais.

---

### SECTION 1: STACK & DEPENDENCIES

*   **Python Environment:** ComfyUI embedded python.
*   **Key Libraries:**
    *   `aiohttp` (Server/API)
    *   `sqlite3` (Database)
    *   `Pillow` (Image processing)
    *   `python-xmp-toolkit` (XMP Metadata support)
*   **System Dependencies:**
    *   **FFmpeg** : Requis dans le PATH systÃ¨me pour le support vidÃ©o (thumbnails, metadata extraction).
    *   `psutil`, `pywinpty` (Windows only) for System Monitor/Terminal.

---

### SECTION 2: FILE STRUCTURE

ðŸ“ holaf_image_viewer_backend/
  > Backend logic for the Image Viewer.
  ðŸ“ routes/
    > Modular API route handlers.
    ðŸ“„ __init__.py
    ðŸ“„ edit_routes.py
    ðŸ“„ export_routes.py
    ðŸ“„ file_ops_routes.py
      > Delete/Restore operations. GÃ¨re les sidecars (.edt, .xmp, .json, .txt).
    ðŸ“„ image_routes.py
      > [**UPDATED**] Listing API. Supporte le tri, les filtres boolÃ©ens, et les filtres de source de workflow (Availability).
    ðŸ“„ metadata_routes.py
    ðŸ“„ thumbnail_routes.py
      > Gestion des thumbnails. DÃ©lÃ¨gue la gÃ©nÃ©ration Ã  logic.py.
    ðŸ“„ utility_routes.py
  ðŸ“„ __init__.py
  ðŸ“„ logic.py
    > [**CRITICAL**] Core logic. Scanner de fichiers, Sync DB.
    > **Video Support:** DÃ©tecte .mp4/.webm via FFmpeg.
    > **Thumbnails:** GÃ©nÃ¨re des JPG statiques pour les vidÃ©os (t=0s).
    > **Metadata:** Extrait dimensions/durÃ©e via ffprobe.
  ðŸ“„ routes.py
  ðŸ“„ worker.py
    > Background tasks.

ðŸ“ js/
  > Frontend assets.
  ðŸ“ css/
    ðŸ“„ holaf_image_viewer.css
      > [**UPDATED**] Styles globaux. Utilise CSS Grid (3 colonnes) pour la liste des formats.
    ðŸ“„ (Autres fichiers CSS inchangÃ©s...)
  ðŸ“ image_viewer/
    ðŸ“„ image_viewer_actions.js
    ðŸ“„ image_viewer_editor.js
    ðŸ“„ image_viewer_gallery.js
      > [**UPDATED**] Affiche l'icÃ´ne ðŸŽ¥ pour les vidÃ©os. Bouton Edit dÃ©sactivÃ© pour les vidÃ©os (pour l'instant).
    ðŸ“„ image_viewer_infopane.js
    ðŸ“„ image_viewer_navigation.js
    ðŸ“„ image_viewer_settings.js
    ðŸ“„ image_viewer_state.js
    ðŸ“„ image_viewer_ui.js
      > [**UPDATED**] Sidebar UI.
      > **Search:** Recherche unifiÃ©e avec boutons Scope (Name, Prompt, Workflow).
      > **Workflow:** Filtre Availability (Internal/External).
  ðŸ“ model_manager/
    > (Fichiers du gestionnaire de modÃ¨les...)
  ðŸ“„ holaf_main.js
  ðŸ“„ (Autres fichiers JS root...)

ðŸ“ nodes/
  ðŸ“„ holaf_model_manager.py
  ðŸ“„ holaf_nodes_manager.py

ðŸ“„ __init__.py
ðŸ“„ __main__.py
ðŸ“„ context.txt
ðŸ“„ holaf_config.py
ðŸ“„ holaf_database.py
  > GÃ¨re la connexion SQLite et les migrations.
ðŸ“„ holaf_server_management.py
ðŸ“„ holaf_system_monitor.py
ðŸ“„ holaf_terminal.py
ðŸ“„ holaf_utils.py
ðŸ“„ requirements.txt

---

### SECTION 3: KEY CONCEPTS

*   **Sync Strategy:** `logic.py` scanne le dossier output. Il compare mtime/size/hash avec la DB. Les vidÃ©os sont traitÃ©es via `subprocess` (FFmpeg).
*   **Thumbnailing:** Les images utilisent PIL. Les vidÃ©os utilisent FFmpeg pour extraire une frame Ã  00:00:00. Format de cache : `.jpg`.
*   **Filtering Logic:**
    *   **Backend:** Construction dynamique de requÃªtes SQL (`image_routes.py`).
    *   **Frontend:** `image_viewer_ui.js` construit un objet filtre JSON.
    *   **Search Scopes:** Le frontend envoie le texte de recherche dans des champs spÃ©cifiques (`filename_search`, etc.) selon les boutons actifs.
*   **Workflow Availability:** Distingue si le workflow est embarquÃ© dans le PNG (`internal_png`) ou dans un sidecar JSON (`external_json`).

---

### SECTION 4: DATABASE SCHEMA

*   **File:** `holaf_utilities.sqlite`
*   **Current Version:** 12
*   **Table `images` (Key Columns):**
    *   `path_canon` (Unique ID path)
    *   `format` (e.g., 'PNG', 'JPG', 'MP4', 'WEBM')
    *   `workflow_source` ('internal_png', 'external_json', 'none')
    *   `has_edits` (Boolean, alias `has_edit_file` in logic)
    *   `width`, `height` (Dimensions, video resolution)
    *   `thumb_hash` (Used for thumbnail caching)
    *   `has_tags`, `has_prompt`, `has_workflow` (Boolean flags for fast filtering)

---

### PROJECT STATE

  ACTIVE_BUGS: {}

  IN_PROGRESS:
    - (Aucune tÃ¢che active - Fin de session)

  COMPLETED_FEATURES (Recent):
    - **[feature, video_support_basic]** : Support MP4/WEBM (Scan, Metadata, Thumbnails via FFmpeg).
    - **[feature, ui, video_indicator]** : IcÃ´ne ðŸŽ¥ dans la galerie.
    - **[refactor, ui, unified_search]** : Barre de recherche unique avec boutons de portÃ©e (Name/Prompt/Workflow).
    - **[refactor, ui, workflow_filter]** : Filtre "Availability" (Internal/External).
    - **[fix, backend, sql_insert_bug]** : Correction du nombre de paramÃ¨tres SQL pour l'insertion d'images.
    - **[fix, ui, formats_grid]** : Affichage des formats sur 3 colonnes.

  ROADMAP:
    Global:
      - [new_tool, session_log_tool]
      - [backend, periodic_maintenance_worker]
    ImageViewer:
      - **AmÃ©liorations Futures (VidÃ©o) :**
          - `[feature, ui, video_hover_preview]` : PrÃ©visualisation au survol.
          - `[feature, ui, video_player_modal]` : Lecteur vidÃ©o simple.
      - **AmÃ©liorations Futures (GÃ©nÃ©ral) :**
          - AmÃ©lioration UX/UI du filtre "Metadata & Sidecars".
--- END OF FILE context.txt ---